<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="st">

	<!-- 게시판에 업로드된 영상 리스트 -->	
	<select id="S_BBS_VIDEO_LIST" resultType="HashMap" parameterType="HashMap" >
		/* S_BBS_VIDEO_LIST */
      SELECT 'id_' || (ROWNUM-1) AS "id" 
      	   , LOWER(A.FILE_EXTENSION)	AS FILE_EXTENSION
      	   , COMM_UTIL_PKG.comm_code_attr('FILE_EXTENSION', UPPER(A.FILE_EXTENSION), 'ATTRIBUTE1', #{LANG_CODE}) AS FILE_TYPE
      	   , A.COMM_FILE_ID
      	   , A.RANDOM_KEY
           , A.FILE_NAME
           , B.BBS_BOARD_ID
           , B.BOARD_NO
           , C.CATEGORY_NAME
           , CASE WHEN B.OPEN_YN = '1'
                  THEN ''
                  ELSE '(' || COMM_UTIL_PKG.lang('비공개', 'KO') || ') ' END || B.TITLE        AS TITLE
           , A.ATTRIBUTE1
        FROM COMM_FILE A
   LEFT JOIN BBS_BOARD B ON (A.GROUP_ID = B.BBS_BOARD_ID AND B.MODULE_CODE = 'ST')
   LEFT JOIN BBS_SETTING C ON (B.CATEGORY_CODE = C.CATEGORY_CODE)
       WHERE A.MODULE_CODE = 'BD'
         AND COMM_UTIL_PKG.comm_code_attr('FILE_EXTENSION', UPPER(A.FILE_EXTENSION), 'ATTRIBUTE1', #{LANG_CODE}) IN ('VIDEO', 'SUB')
         <if test="@prjb.com.util.ComUtil@nvl(TITLE, '') != ''">
		 	<![CDATA[
		 	AND INSTR(B.TITLE, #{TITLE}) > 0
		 	]]> 
		 </if>
       ORDER BY B.BBS_BOARD_ID DESC, TO_NUMBER(COMM_UTIL_PKG.comm_code_attr('FILE_EXTENSION', UPPER(A.FILE_EXTENSION), 'SEQ', #{LANG_CODE})) ASC
	</select>
	
	<!-- 영상 리스트 -->	
	<select id="S_ST_VIDEO" resultType="HashMap" parameterType="HashMap" >
		/* S_ST_VIDEO */
      SELECT 'id_' || (ROWNUM-1) AS "id" 
      	   , A.ST_VIDEO_ID
      	   , A.CATEGORY_NAME		AS CATEGORY_NAME
      	   , A.UP_CATEGORY_NAME		AS UP_CATEGORY_NAME
      	   , A.VIDEO_NAME
      	   , A.OPEN_YN
      	   , A.DESCRIPTION
        FROM ST_VIDEO A
       START WITH A.UP_CATEGORY_NAME IS null 
     CONNECT BY PRIOR A.CATEGORY_NAME = A.UP_CATEGORY_NAME
       ORDER SIBLINGS BY A.CATEGORY_NAME
	</select>
	<!-- 영상 리스트 조회 -->	
	<select id="S_ST_VIDEO_VIEW" resultType="HashMap" parameterType="HashMap" >
		/* S_ST_VIDEO_VIEW */
	       SELECT 'id_' || (ROWNUM-1) AS "id"
		       , LEVEL-1 AS "indent"
		       , SUBSTR( SYS_CONNECT_BY_PATH(ROWNUM, '_')
		           , (INSTR(SYS_CONNECT_BY_PATH(ROWNUM, '_'), '_', -1, 2)+1)
		           , (INSTR(SYS_CONNECT_BY_PATH(ROWNUM, '_'), '_', -1) - (INSTR(SYS_CONNECT_BY_PATH(ROWNUM, '_'), '_', -1, 2)+1)) ) -1  AS "parent"
		       , A.ST_VIDEO_ID
		       , A.CATEGORY_NAME
		       , A.VIDEO_NAME
	      	FROM ST_VIDEO A
	  START WITH A.UP_CATEGORY_NAME IS null 
	 CONNECT BY PRIOR A.CATEGORY_NAME = A.UP_CATEGORY_NAME
	 ORDER SIBLINGS BY A.CATEGORY_NAME
	</select>
	
	<!-- 파일변환 매핑정보만 추가 -->	
	<insert id="I_FILE_MAPPING_COPY" parameterType="HashMap">
	INSERT INTO COMM_FILE( COMM_FILE_ID    
						 , MODULE_CODE     
						 , GROUP_ID        
						 , FILE_PATH       
						 , RANDOM_KEY      
						 , FILE_NAME       
						 , FILE_EXTENSION  
						 , FILE_SIZE       
						 , SERVER_FILE_NAME
						<include refid="config.cidColumn"></include>
						)
				  SELECT COMM_FILE_S.NEXTVAL    
					   , #{MODULE_CODE}     
					   , #{GROUP_ID}        
					   , A.FILE_PATH
					   , A.RANDOM_KEY      
					   , A.FILE_NAME       
					   , A.FILE_EXTENSION  
					   , A.FILE_SIZE       
					   , A.SERVER_FILE_NAME
					   , #{CID}
				       , SYSDATE
					   , #{CIP}
					   , #{CID}
					   , SYSDATE    
					   , #{CIP}        
				    FROM COMM_FILE A
				   WHERE A.COMM_FILE_ID = #{COMM_FILE_ID}        
	</insert>
	<!-- 영상 리스트(업로드된 파일) 조회 -->	
	<select id="S_ST_VIDEO_VIEW_FILE" resultType="HashMap" parameterType="HashMap" >
		/* S_ST_VIDEO_VIEW_FILE */
	       SELECT 'id_' || (ROWNUM-1) AS "id"
		       , LEVEL-1 AS "indent"
		       , SUBSTR( SYS_CONNECT_BY_PATH(ROWNUM, '_')
		           , (INSTR(SYS_CONNECT_BY_PATH(ROWNUM, '_'), '_', -1, 2)+1)
		           , (INSTR(SYS_CONNECT_BY_PATH(ROWNUM, '_'), '_', -1) - (INSTR(SYS_CONNECT_BY_PATH(ROWNUM, '_'), '_', -1, 2)+1)) ) -1  AS "parent"
		       , A.ST_VIDEO_ID
		       , A.CATEGORY_NAME
		       , A.VIDEO_NAME
	      	FROM ST_VIDEO A
         WHERE (
               (VIDEO_NAME IS NULL
               AND 1=1
               )
               OR
               (VIDEO_NAME IS NOT NULL
               AND 
               EXISTS(
                        SELECT COMM_FILE_ID
                          FROM COMM_FILE
                         WHERE MODULE_CODE = 'ST'
                           AND UPPER(FILE_EXTENSION) = 'MP4'
                           AND GROUP_ID = A.ST_VIDEO_ID
                        ))
               )
	  START WITH A.UP_CATEGORY_NAME IS null 
	 CONNECT BY PRIOR A.CATEGORY_NAME = A.UP_CATEGORY_NAME
	 ORDER SIBLINGS BY A.CATEGORY_NAME
	</select>
	<!-- 파일변환 매핑한 파일 조회 -->
	<select id="S_MAPPING_FILE" resultType="HashMap" parameterType="HashMap" >
		SELECT 'id_' || (ROWNUM-1) AS "id"
			 , A.COMM_FILE_ID
			 , A.MODULE_CODE
			 , A.GROUP_ID
			 , A.FILE_NAME
			 , A.FILE_EXTENSION
			 , A.FILE_SIZE
			 , B.VIDEO_NAME
			 , A.RANDOM_KEY
			 , A.DESCRIPTION
			 , A.ATTRIBUTE1
			 , COMM_UTIL_PKG.comm_code_attr('FILE_EXTENSION', UPPER(A.FILE_EXTENSION), 'ATTRIBUTE1', #{LANG_CODE}) AS FILE_TYPE
		  FROM COMM_FILE A
	 	  JOIN ST_VIDEO B ON (A.GROUP_ID = B.ST_VIDEO_ID)
		 WHERE A.MODULE_CODE 	= 'ST'
		   AND A.GROUP_ID 		= #{ST_VIDEO_ID}
		 ORDER BY A.COMM_FILE_ID ASC
	</select>
	<!-- 파일변환 매핑한 파일 수정 -->
	<update id="U_MAPPING_FILE" parameterType="HashMap">
		UPDATE COMM_FILE
		   SET DESCRIPTION = #{DESCRIPTION}
		   	 , ATTRIBUTE1 = #{ATTRIBUTE1}
		   	 , MID = #{MID}
		   	 , MIP = #{MIP}
		   	 , MDT = SYSDATE
		 WHERE COMM_FILE_ID = #{COMM_FILE_ID}
		   AND RANDOM_KEY = #{RANDOM_KEY}
	</update>
</mapper>